 <p-toolbar>

        <div class="p-toolbar-group-left">
          <app-header-form
            [id]="id"
            label="Editar"
            [icon]="PrimeIcons.PENCIL"/>
        </div>

        <div class="p-toolbar-group-right">
          <app-form-button-action
            (submit)="onSubmit()"
            (cancel)="prevOutput.emit(true)"
            labelSubmitButton="Siguiente"
            labelCancelButton="Atrás"
            [iconSubmitButton]="PrimeIcons.ARROW_RIGHT"
            [isVisibleCancelButton]="true"
          />
        </div>

      </p-toolbar>
<form class="p-fluid grid">
  
  <!-- internalInstitutionsForm -->
  <div class="field col-12 xl:col-12 lg:col-12 md:col-12 sm:col-12">
<p-panel header="Ministerio de Turismo">
      <form [formGroup]="internalInstitutionForm" class="p-fluid grid">
        <!-- internalInstitutions/personTypeId -->
        <div class="field col-12 xl:col-5 lg:col-5 md:col-5 sm:col-12">
          <label appLabel
                 for="internalPersonType"
                 [label]="InternalInstitutionsFormEnum.personType"
                 [required]="internalInstitutionPersonTypeField">
          </label>
          <app-form-help-field content="Esto es un mensaje de prueba"></app-form-help-field>
          <p-dropdown
            id="internalPersonType"
            formControlName="personType"
            dataKey="id"
            [options]="internalPersonTypes"
            placeholder="Seleccione"
            [filter]="false">
            <ng-template pTemplate="selectedItem" let-selectedOption>
              <div class="flex align-items-center gap-2">
                <div>{{ selectedOption.name }}</div>
              </div>
            </ng-template>
            <ng-template let-item pTemplate="item">
              <div class="flex align-items-center gap-2">
                <div>{{ item.name }}</div>
              </div>
            </ng-template>
          </p-dropdown>
          <small
            appErrorMessage
            [errors]="internalInstitutionPersonTypeField.errors"
            [touched]="internalInstitutionPersonTypeField.touched"
            [dirty]="internalInstitutionPersonTypeField.dirty">
          </small>
        </div>
      </form>

    <form [formGroup]="internalInstitutionDetailForm" class="p-fluid grid">
        <!-- internalInstitutions/positionId -->
        <div class="field col-12 xl:col-6 lg:col-6 md:col-6 sm:col-12">
          <label appLabel
                 for="internalPosition"
                 [label]="InternalInstitutionsFormEnum.position"
                 [required]="internalInstitutionDetailPositionField">
          </label>
          <app-form-help-field content="Esto es un mensaje de prueba"></app-form-help-field>
          <p-dropdown
            id="internalPosition"
            formControlName="position"
            dataKey="id"
            [options]="positions"
            placeholder="Seleccione"
            [filter]="false">
            <ng-template pTemplate="selectedItem" let-selectedOption>
              <div class="flex align-items-center gap-2">
                <div>{{ selectedOption.name }}</div>
              </div>
            </ng-template>
            <ng-template let-item pTemplate="item">
              <div class="flex align-items-center gap-2">
                <div>{{ item.name }}</div>
              </div>
            </ng-template>
          </p-dropdown>
          <small
            appErrorMessage
            [errors]="internalInstitutionDetailPositionField.errors"
            [touched]="internalInstitutionDetailPositionField.touched"
            [dirty]="internalInstitutionDetailPositionField.dirty">
          </small>
        </div>
    
        <!-- button add internalInstitution -->
        @if (agreement.internalInstitutions && agreement.internalInstitutions.length < 1) {
          <div class="ml-2" style="display: flex; align-items: center;">
            <p-button
              label="Añadir"
              [icon]="PrimeIcons.PLUS"
              [severity]="SeverityButtonActionEnum.ADD"
              (click)="addInternalInstitution()"
              class="button-adjustment "/>
  </div>
        } 
      </form>

      <!-- table internal-->
      @if (agreement.internalInstitutions && agreement.internalInstitutions.length > 0) {
        <p-table [value]="agreement.internalInstitutions" [tableStyle]="{ 'min-width': '50rem' }">
          <ng-template pTemplate="header">
            @for (col of internalInstitutionsColumns; track col.field) {
              <th [pSortableColumn]="col.field">
                {{ col.header }}
              </th>
            }
            <th>Acciones</th>
          </ng-template>
          <ng-template pTemplate="body" let-internalInstitution let-rowIndex="rowIndex">
            <tr>
              <td class="text-center">{{ internalInstitution.personType.name}}</td>
              <td class="text-center">{{ internalInstitution.name }}</td>
              <td>
                @for (internalInstitutionDetail of internalInstitution.internalInstitutionDetails; track internalInstitutionDetail; let index = $index) {
                  <ul>
                      {{ internalInstitutionDetail.position.name }}
                  </ul>
                }
              </td>
              <td>
                <div class="button-group">
                  <button pButton
                          [icon]="PrimeIcons.TRASH"
                          [severity]="SeverityButtonActionEnum.DELETE"
                          (click)="deleteInternalInstitution(rowIndex)">
                  </button>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      }
    </p-panel>
  </div>

  <!-- externalInstitutionsForm -->
  <div class="field col-12 xl:col-12 lg:col-12 md:col-12 sm:col-12">
    <p-panel header="Contraparte">
      <form [formGroup]="externalInstitutionForm" class="p-fluid grid">
        <!-- externalInstitutions/personTypeId -->
        <div class="field col-12 xl:col-6 lg:col-6 md:col-6 sm:col-12">
          <label appLabel
                 for="externalPersonType"
                 [label]="ExternalInstitutionsFormEnum.personType"
                 [required]="externalInstitutionPersonTypeField">
          </label>
          <app-form-help-field content="Esto es un mensaje de prueba"></app-form-help-field>
          <p-dropdown
            id="externalPersonType"
            formControlName="personType"
            dataKey="id"
            [options]="externalPersonTypes"
            placeholder="Seleccione"
            [filter]="false">
            <ng-template pTemplate="selectedItem" let-selectedOption>
              <div class="flex align-items-center gap-2">
                <div>{{ selectedOption.name }}</div>
              </div>
            </ng-template>
            <ng-template let-item pTemplate="item">
              <div class="flex align-items-center gap-2">
                <div>{{ item.name }}</div>
              </div>
            </ng-template>
          </p-dropdown>
          <small
            appErrorMessage
            [errors]="externalInstitutionPersonTypeField.errors"
            [touched]="externalInstitutionPersonTypeField.touched"
            [dirty]="externalInstitutionPersonTypeField.dirty">
          </small>
        </div>

        <!-- externalInstitutions/name -->
        <div class="field col-12 xl:col-6 lg:col-6 md:col-6 sm:col-12">
          <label appLabel for="name"
                 [label]="ExternalInstitutionsFormEnum.name"
                 [required]="externalInstitutionNameField">
          </label>
          <app-form-help-field content="Esto es un mensaje de prueba"></app-form-help-field>
          <input
            pInputText
            id="name"
            formControlName="name"/>
          <small
            appErrorMessage
            [errors]="externalInstitutionNameField.errors"
            [touched]="externalInstitutionNameField.touched"
            [dirty]="externalInstitutionNameField.dirty">
          </small>
        </div>
      </form>
      <!-- button add externalInstitution -->
      <div class="field col-12" style="display: flex; justify-content: right">
      @if(this.isEditing){
        <div class="button-group">
         <p-button
          label="Editar"
          [icon]="PrimeIcons.PENCIL"
          [severity]="SeverityButtonActionEnum.RETURN"
          (click)="updateExternalInstitution()"/>

          <p-button
          label="Cancelar"
          [icon]="PrimeIcons.TIMES"
          [severity]="SeverityButtonActionEnum.DELETE"
          (click)="cancelEdit()"/> </div>
      } @else {
        <p-button
          label="Añadir"
          [icon]="PrimeIcons.PLUS"
          [severity]="SeverityButtonActionEnum.ADD"
          (click)="addExternalInstitution()"/> }
      </div>

 
      <!-- table external-->
      @if (agreement.externalInstitutions && agreement.externalInstitutions.length > 0) {
        <p-table [value]="agreement.externalInstitutions" [tableStyle]="{ 'min-width': '50rem' }">
          <ng-template pTemplate="header">
            @for (col of externalInstitutionsColumns; track col.field) {
              <th [pSortableColumn]="col.field">
                {{ col.header }}
              </th>
            }
            <th>Acciones</th>
          </ng-template>
          <ng-template pTemplate="body" let-externalInstitution let-rowIndex="rowIndex">
            <tr>
              <td class="text-center">{{ externalInstitution.personType.name}}</td>
              <td class="text-center" >{{ externalInstitution.name }}</td>
              <td>
                @for (externalInstitutionDetail of externalInstitution.externalInstitutionDetails; track externalInstitutionDetail; let index = $index) {
                  <ul>
                    <div  class="button-group">
                     {{ externalInstitutionDetail.position }}
                    <p-button
                      [icon]="PrimeIcons.TRASH"
                      [severity]="SeverityButtonActionEnum.DELETE"
                      (click)="deleteExternalInstitutionDetail(rowIndex,index)"/>
                    
                      <p-button
                      [icon]="PrimeIcons.PENCIL"
                      [severity]="SeverityButtonActionEnum.RETURN"
                      (click)="editExternalInstitutionDetail(rowIndex,index)"
                       />

                     </div>
                  </ul>
                }
              </td>
              <td>
                <div class="button-group">
                  <button pButton
                          [icon]="PrimeIcons.PLUS"
                          [severity]="SeverityButtonActionEnum.ADD"
                          (click)="showExternalInstitutionDetailModal(rowIndex)">
                  </button>
                  <button pButton
                          [icon]="PrimeIcons.TRASH"
                          [severity]="SeverityButtonActionEnum.DELETE"
                          (click)="deleteExternalInstitution(externalInstitution)">
                  </button>
                  <p-button
                  [icon]="PrimeIcons.PENCIL"
                  [severity]="SeverityButtonActionEnum.RETURN"
                  (click)="editExternalInstitution(rowIndex)"/>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      }
    </p-panel>
  </div>
</form>

<p-dialog
  [(visible)]="isVisibleExternalInstitutionDetailForm"
  [modal]="true"
  [style]="{width: '50%'}"
  header="Gestión de Archivos">
  <form [formGroup]="externalInstitutionDetailForm" class="p-fluid grid">
    <!-- externalInstitutions/position -->
    <div class="field col-12 xl:col-6 lg:col-6 md:col-6 sm:col-12">
      <label appLabel
             for="externalPosition"
             [label]="ExternalInstitutionsFormEnum.position"
             [required]="externalInstitutionDetailPositionField">
      </label>
      <app-form-help-field content="Esto es un mensaje de prueba"></app-form-help-field>
      <input
        pInputText
        id="externalPosition"
        formControlName="position"/>
      <small
        appErrorMessage
        [errors]="externalInstitutionDetailPositionField.errors"
        [touched]="externalInstitutionDetailPositionField.touched"
        [dirty]="externalInstitutionDetailPositionField.dirty">
      </small>
    </div>

    <!-- externalInstitutions/unit -->
    <div class="field col-12 xl:col-6 lg:col-6 md:col-6 sm:col-12">
      <label appLabel for="unit"
             [label]="ExternalInstitutionsFormEnum.unit"
             [required]="externalInstitutionDetailUnitField">
      </label>
      <app-form-help-field content="Esto es un mensaje de prueba"></app-form-help-field>
      <input
        pInputText
        id="unit"
        formControlName="unit"/>
      <small
        appErrorMessage
        [errors]="externalInstitutionDetailUnitField.errors"
        [touched]="externalInstitutionDetailUnitField.touched"
        [dirty]="externalInstitutionDetailUnitField.dirty">
      </small>
    </div>

    <div class="field col-12" style="display: flex; justify-content: right">
        @if( this.isEditingDetail){
          <div class="button-group">
           <p-button
            label="Editar"
            [icon]="PrimeIcons.PENCIL"
            [severity]="SeverityButtonActionEnum.RETURN"
            (click)="updateExternalInstitutionDetail()"/>
  
            <p-button
            label="Cancelar"
            [icon]="PrimeIcons.TIMES"
            [severity]="SeverityButtonActionEnum.DELETE"
            (click)="cancelEditDetail()"/> </div>
        } @else {
          <p-button
        label="Añadir"
        [icon]="PrimeIcons.PLUS"
        [severity]="SeverityButtonActionEnum.ADD"
        (click)="addExternalInstitutionDetail()"/>
        }
    </div>
  </form>
</p-dialog>
