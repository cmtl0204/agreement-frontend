<div class="grid">
  <div class="col-12">
    @if (coreService.isLoading) {
    <app-skeleton [type]="SkeletonEnum.CARD"></app-skeleton>
    }

    @if (!coreService.isLoading) {
      <p-toolbar>
        <div class="p-toolbar-group-left">
          <app-header-form
            label="Registro"
            [icon]="PrimeIcons.PENCIL"/>
        </div>

        <div class="p-toolbar-group-right">
          <app-form-button-action
            (submit)="onSubmit()"
            (cancel)="prevOutput.emit(true)"
            labelSubmitButton="Siguiente"
            labelCancelButton="Atrás"
            [iconSubmitButton]="PrimeIcons.ARROW_RIGHT"
            [isVisibleCancelButton]="true"
          />
        </div>
      </p-toolbar>
    <div class="p-fluid">

      <p-multiSelect [options]="obligationType" [(ngModel)]="selectedObligationTypes"  optionLabel="name"
      placeholder="Select Obligations"/>

        <!-- MINTUR -->
        <div *ngFor="let obligation of selectedObligationTypes">
          <ng-container [ngSwitch]="obligation.name">
            <div *ngSwitchCase="'obligacion mintur'">
              <div class="p-fluid">
                
                  
                
                <p-panel>
                  <div class="p-fluid">
                    <div class="p-field p-grid">
                      <div class="p-col-12 p-md-10">
                        <label for="obligationDescription" class="p-col-12 p-md-2"><strong>Descripción</strong></label>
                        <textarea id="obligationDescription" rows="3" cols="30" #obligationDescription pInputTextarea></textarea>
                      </div>
                      <div class="p-col-12 p-md-2" style="display: flex; align-items: center;">
                        <p-button 
                        (click)="addMinturObligation(obligationMintur[0], obligationDescription.value); obligationDescription.value = ''" 
                        label="Agregar" 
                        icon="pi pi-plus" 
                        severity="success"
                        [disabled]="!obligationDescription.value"></p-button>
                      </div>
                    </div>
                  </div>
                  
                  
                  <p-table [value]="obligationMintur">
                    <ng-template pTemplate="header">
                      <tr>
                        <th>Entidad</th>
                        <th>Obligaciones</th>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-institution let-i="rowIndex">
                      <tr>
                        <td><strong>{{ institution.name }}</strong></td>
                        <td>
                          <ng-container *ngIf="obligations.controls.length > 0">
                            <table style="width: 100%;">
                              <tr *ngFor="let obligation of obligations.controls; let j = index">
                                <ng-container *ngIf="obligation.get('model')?.value === institution.name">
                                  <td style="width: 80%;">{{ obligation.get('description')?.value }}</td>
                                  <td style="width: 20%;">
                                    <p-button (click)="deleteObligation(j)" icon="pi pi-trash" severity="danger"></p-button>
                                  </td>
                                </ng-container>
                              </tr>
                            </table>
                          </ng-container>
                        </td>
                      </tr>
                    </ng-template>
                  </p-table>
                </p-panel>
              </div>
            </div>

            <!-- OBLIGACION CONTRAPARTE -->
            <div *ngSwitchCase="'obligacion contraparte'">
              <div class="p-fluid">
                <p-panel>
                  <p-table [value]="externalInstitutions">
                    <ng-template pTemplate="header">
                      <tr>
                        <th>Entidad</th>
                        <th>Obligaciones</th>
                        <th>Acciones</th>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-institution let-i="rowIndex">
                      <tr>
                        <td>{{ institution.name }}</td>
                        <td>
                          <ng-container *ngIf="obligations.controls.length > 0">
                            <table style="width: 100%;">
                              <tr *ngFor="let obligation of obligations.controls; let j = index">
                                <ng-container *ngIf="obligation.get('model')?.value === institution.name">
                                  <td style="width: 80%;">{{ obligation.get('description')?.value }}</td>
                                  <td style="width: 20%;">
                                    <p-button (click)="deleteObligation(j)" icon="pi pi-trash" severity="danger"></p-button>
                                  </td>
                                </ng-container>
                              </tr>
                            </table>
                          </ng-container>
                        </td>                        
                        <td>
                          <p-button (click)="openModal(institution.name)" label="Agregar" severity="success" icon="pi pi-plus"></p-button>
                        </td>
                      </tr>
                    </ng-template>
                  </p-table>
                </p-panel>
              </div>
            </div>
            
            <p-dialog [(visible)]="displayModal" [modal]="true" [closable]="false" header="Agregar Obligación" [style]="{width: '50vw'}">
              <form [formGroup]="obligationForm" (ngSubmit)="addObligationAndCloseModal()">
                <div class="p-fluid">
                  <div class="p-field">
                    <label for="model"><strong>Entidad</strong></label>
                    <input id="model" formControlName="model" type="text" pInputText readonly>
                  </div>
                  <div class="p-field">
                    <label for="description"><strong>Obligaciones</strong></label>
                    <textarea id="description" formControlName="description" rows="5" pInputTextarea></textarea>
                  </div>
                </div>
                <p-footer>
                  <div class="col-12">
                    <div class="col-6">
                      <p-button label="Cancelar" icon="pi pi-times" (click)="closeModal()" severity="danger"></p-button>
                    </div>
                    <div class="col-6">
                      <p-button label="Agregar" icon="pi pi-check" type="submit" severity="success" [disabled]="obligationForm.invalid"></p-button>
                    </div>
                  </div>
                </p-footer>
              </form>
            </p-dialog>
            

            <div *ngSwitchCase="'obligacion conjunta'">
              <!-- Content for obligacion conjunta -->
              <p>Graph or content for Obligation Conjunta</p>
            </div>
          </ng-container>
        </div>
      </div> 
    }
  </div>
</div>